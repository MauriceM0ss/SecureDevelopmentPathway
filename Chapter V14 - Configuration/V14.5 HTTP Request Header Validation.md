# V14.5 HTTP Request Header Validation

## 14.5.1 Verify that the application server only accepts the HTTP methods in use by the application/API, including pre-flight OPTIONS, and logs/alerts on any requests that are not valid for the application context

Deze requirement gaat over het beperken en controleren van de HTTP-methoden die een applicatie of API accepteert om de beveiliging te versterken. 

Het is belangrijk om headers te controleren om onnodige risico's te voorkomen, e.g. een DELETE header die niet benodigd is voor de functionaliteit of een arbitraire header die mogelijk verkeerd geïnterpreteerd kan worden door de server, door bij de OPTIONS header mee te geven welke headers zijn toegestaan, e.g. GET en POST voorkom je dat dit mogelijk is. Indien een verzoek hier van afwijkt is dit verdacht omdat hierbij niet de specificaties worden gevolgd, om deze reden is het ook aanbevolen om dit te loggen en door het SIEM op te laten volgen.

### Hoe te testen?

#### Optie 1 (manueel)

1. Indexeer welke methode zijn toegestaan voor de webpagina.
2. Open een terminal en verstuur het volgende commando:

    ```bash
    curl -i -X OPTIONS http://example.org/
    ```

3. Of voor een API

    ```bash
    curl -i -X OPTIONS http://example.org/
    ```

4. Controleer of dit overeenkomt met de verwachte HTTP methods zoals te zien is in de `Allow` header, e.g.:

    ```text
    HTTP/1.1 204 No Content
    Allow: OPTIONS, GET, HEAD, POST
    Cache-Control: max-age=604800
    Date: Thu, 13 Oct 2016 11:45:00 GMT
    Server: EOS (lax004/2813)
    https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/OPTIONS
    ```

5. Om logging te controleren stuur e.g.:

    ```bash
    curl -i -X HEADERDOESNOTEXIST http://example.org/
    ```

6. Controleer of deze wordt gelogd.

### Hoe te implementeren?

Maak een ontwerp voor hoe je de applicatie wilt inrichten, rekening houdend met welke methodes je nodig hebt en de uitzonderingen voor specifieke API calls. Beschrijf dit en neem de volgende stappen als leidraad:

1. Indexeer de gewenste methode voor de website
2. Indexeer uitzonderingen voor specifieke API calls
3. Configureer de server om op OPTIONS enkel de verwachte methode te retenuren.
4. Schrijf unit test om dit per call te verifiëren, e.g. OPTIONS en kijken naar response.

## 14.5.2 Verify that the supplied Origin header is not used for authentication or access control decisions, as the Origin header can easily be changed by an attacker

De `Origin` header komt van de browser van een gebruiker, dus deze is inherent niet te vertrouwen. Deze moet daarom ook niet als authenticatie of access control gebruikt worden, omdat deze door een aanvaller mogelijk aangepast kan worden. De toegang moet dan ook bepaald worden op de server.

### Hoe te testen?

#### Optie 1 (manueel)

1. Gebruik een proxy tool zoals Burp Suite of OWASP ZAP om HTTP-verzoeken te onderscheppen en de Origin header te wijzigen.
2. Stuur een verzoek naar je applicatie en wijzig de Origin header naar een waarde die normaal gesproken niet zou moeten worden toegestaan, bijvoorbeeld een ongeautoriseerde origin.
3. Probeer dit ook met 127.0.0.1 (localhost)
     * Bijvoorbeeld '<http://127.0.0.1>' of '<https://127.0.0.1>'
     * Of probeer verschillende poorten zoals 3000 of 8080
     * De IPv6 variant: http://[::1]
4. Controleer de serverreactie om te zien of de toegang wordt verleend of geweigerd op basis van de gewijzigde Origin header; de verwachte respons is dat dit niet mag. Lukt het wel, dan is de 'Origin' header wellicht gebruikt voor authentication of access control.

### Hoe te implementeren?

Er zijn meerdere stappen om dit te implementeren:

1. Gebruik sterke authenticatie zoals JSON Web Tokens (JWT), oAuth tokens of andere varianten.
2. Gebruik server-side sessies met veilige cookies (HttpOnly, Secure).
3. Vermijd vertrouwen op Client-Side headers zoals 'Origin', 'Referer' of 'User-Agent' voor authenticatie of access control.
4. Valideer de gebruikersidentiteit en rechten via een rechten matrix, sessies, tokens.
5. CORS Correct configureren (Zie hiervoor de pagina [Best Practice - Cross-Origin Resource Sharing (CORS)](../Best%20Practices/Best%20Practice%20-%20Cross-Origin%20Resource%20Sharing%20(CORS).md):
    * Beperk Origins
    * Access-Control-Allow-Origin Header
    * Access-Control-Allow-Credentials

## 14.5.3 Verify that the Cross-Origin Resource Sharing (CORS) Access-Control-Allow-Origin header uses a strict allow list of trusted domains and subdomains to match against and does not support the "null" origin

Om het risico van Cross-Origin aanvallen te beperken, voorkom je een aantal problemen:

* Cross-Site Request Forgery (CSRF)
* Cross-Site Scripting (XSS)
* Bescherming tegen de 'null' origin
* Kleinere attack surface door beperkingen

Door beperkingen van je origins in te stellen zorg je er dus voor dat alleen de door jou vertrouwde bronnen gebruikt kunnen worden.

### Hoe te testen?

#### Optie 1 (manueel)

1. Open in je browser een random pagina waarvan je weet dat deze niet in je Access-Control-Allow-Origin header zit.
2. Open je DevTools door op F12 te drukken.
3. Type 'allow pasting' als nodig en druk op Enter
4. Voer het onderstaande commando uit

    ```javascript
    fetch('https://jouwapplicatie.nl')
    ```

    * De verwachte respons is dat niet mag fetchen vanaf de huidige pagina naar jouw eigen applicatie.

### Hoe te implementeren?

Om de CORS header correct te configureren, zie hiervoor de pagina [Best Practice - Cross-Origin Resource Sharing (CORS)](../Best%20Practices/Best%20Practice%20-%20Cross-Origin%20Resource%20Sharing%20(CORS).md)
